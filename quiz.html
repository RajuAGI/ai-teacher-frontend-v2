<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz ‚Äî AI Teacher</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ===== TOPIC PAGE ===== */
    .topic-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:14px; margin-bottom:24px; }
    .topic-btn { background:var(--dark2); border:2px solid var(--border); border-radius:14px; padding:20px 14px; text-align:center; cursor:pointer; transition:all 0.25s; }
    .topic-btn:hover  { border-color:var(--primary); transform:translateY(-3px); box-shadow:0 8px 24px rgba(233,69,96,0.2); }
    .topic-btn .t-icon{ font-size:36px; margin-bottom:8px; }
    .topic-btn h4     { font-size:14px; font-weight:700; color:var(--text); }
    .add-topic-row { display:flex; gap:10px; }
    .section-head { font-size:18px; font-weight:800; margin-bottom:14px; }

    /* ===== LOADING PAGE ===== */
    .loading-wrap { max-width:520px; margin:0 auto; text-align:center; padding:40px 20px; }
    .loading-title { font-size:24px; font-weight:800; margin-bottom:8px; }
    .loading-sub   { color:var(--muted); font-size:14px; margin-bottom:28px; }
    .step-list { text-align:left; display:inline-block; }
    .step-item { font-size:14px; padding:8px 0; color:var(--muted); transition:all 0.3s; }
    .step-item.done   { color:var(--green); }
    .step-item.active { color:var(--gold); font-weight:700; }

    /* ===== QUIZ GAME ===== */
    .quiz-header { display:flex; justify-content:space-between; align-items:center; background:var(--dark2); border:1px solid var(--border); border-radius:14px; padding:14px 20px; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
    .timer-box { background:var(--dark3); border:2px solid var(--border); border-radius:10px; padding:8px 18px; font-size:20px; font-weight:800; color:var(--gold); min-width:70px; text-align:center; }
    .timer-box.warn { border-color:var(--primary); color:var(--primary); animation:timerPulse 0.5s ease-in-out infinite; }
    @keyframes timerPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    .quiz-progress { flex:1; min-width:120px; }
    .progress-track { height:8px; background:var(--dark3); border-radius:4px; overflow:hidden; margin-bottom:4px; }
    .progress-bar-fill { height:100%; background:linear-gradient(90deg,var(--primary),var(--gold)); border-radius:4px; transition:width 0.4s; }
    .q-meta { font-size:12px; color:var(--muted); }

    .level-badge { padding:4px 14px; border-radius:20px; font-size:12px; font-weight:700; }
    .level-easy   { background:rgba(46,204,113,0.2); color:var(--green); border:1px solid var(--green); }
    .level-medium { background:rgba(244,196,48,0.2); color:var(--gold);  border:1px solid var(--gold); }
    .level-hard   { background:rgba(233,69,96,0.2);  color:var(--primary); border:1px solid var(--primary); }

    .question-card { background:var(--dark2); border:1px solid var(--border); border-radius:16px; padding:24px; margin-bottom:16px; }
    .question-text { font-size:17px; font-weight:600; line-height:1.7; margin-bottom:20px; }
    .question-en   { font-size:13px; color:var(--muted); margin-top:4px; font-style:italic; }
    .options-grid  { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .option-btn { background:var(--dark3); border:2px solid var(--border); border-radius:12px; padding:14px 16px; cursor:pointer; font-size:14px; font-family:'Hind',sans-serif; color:var(--text); text-align:left; transition:all 0.2s; line-height:1.5; }
    .option-btn:hover:not(:disabled) { border-color:var(--blue); background:rgba(52,152,219,0.1); }
    .option-btn.correct  { border-color:var(--green)!important; background:rgba(46,204,113,0.15)!important; color:var(--green)!important; }
    .option-btn.wrong    { border-color:var(--primary)!important; background:rgba(233,69,96,0.15)!important; color:var(--primary)!important; }
    .option-btn.selected { border-color:var(--gold); }

    .explain-box { background:var(--dark3); border-left:3px solid var(--gold); border-radius:0 10px 10px 0; padding:12px 14px; font-size:13px; line-height:1.6; margin-top:12px; display:none; }

    /* ===== RESULT PAGE ===== */
    .result-wrap { max-width:560px; margin:0 auto; text-align:center; }
    .score-circle { width:140px; height:140px; border-radius:50%; border:6px solid var(--primary); margin:0 auto 20px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--dark2); }
    .score-big { font-size:42px; font-weight:800; color:var(--primary); line-height:1; }
    .score-of  { font-size:14px; color:var(--muted); }
    .grade { font-size:22px; font-weight:800; margin-bottom:8px; }
    .grade-A { color:var(--gold); }
    .grade-B { color:var(--green); }
    .grade-C { color:var(--blue); }
    .grade-D { color:var(--primary); }
    .stat-row { display:flex; justify-content:center; gap:24px; flex-wrap:wrap; margin:20px 0; }
    .stat-item { background:var(--dark2); border:1px solid var(--border); border-radius:12px; padding:14px 20px; text-align:center; }
    .stat-item .val { font-size:22px; font-weight:800; }
    .stat-item .lbl { font-size:12px; color:var(--muted); }
    .coin-claim-box { background:linear-gradient(135deg,rgba(244,196,48,0.1),rgba(233,69,96,0.1)); border:1px solid var(--gold); border-radius:14px; padding:20px; margin:20px 0; text-align:left; }
    .coin-amount { font-size:32px; font-weight:800; color:var(--gold); }

    @media(max-width:600px){
      .options-grid { grid-template-columns:1fr; }
      .quiz-header  { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <div id="nav-placeholder"></div>
  <main class="page-wrap">

    <!-- TOPIC SELECTION PAGE -->
    <div id="topicPage">
      <div class="page-header">
        <h1>üß† Quiz</h1>
        <p>Topic ‡§ö‡•Å‡§®‡•ã ‚Üí 15 bilingual ‡§∏‡§µ‡§æ‡§≤ ‚Üí TeamCoins ‡§ï‡§Æ‡§æ‡§ì!</p>
      </div>
      <div class="section-head">üìÇ Built-in Topics</div>
      <div class="topic-grid" id="topicGrid"></div>
      <div class="section-head">‚ûï Custom Topic</div>
      <div class="add-topic-row">
        <input class="input" id="customTopicInput" placeholder="‡§ï‡•ã‡§à ‡§≠‡•Ä topic ‡§≤‡§ø‡§ñ‡•ã ‡§ú‡•à‡§∏‡•á: Mughal Empire, Photosynthesis..." style="max-width:400px" />
        <button class="btn btn-primary" onclick="startQuizCustom()">Quiz ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•ã ‚û§</button>
      </div>
    </div>

    <!-- LOADING PAGE -->
    <div id="loadingPage" style="display:none">
      <div class="loading-wrap">
        <div class="loading-title" id="loadingTitle">‡§∏‡§µ‡§æ‡§≤ ‡§¨‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</div>
        <div class="loading-sub">AI 15 bilingual (Hindi + English) ‡§∏‡§µ‡§æ‡§≤ ‡§¨‡§®‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§ 15-20 seconds ‡§≤‡§ó‡•á‡§Ç‡§ó‡•á‡•§<br><strong style="color:var(--gold)">‡§™‡§π‡§≤‡•Ä ‡§¨‡§æ‡§∞ 60-90 sec ‡§≤‡§ó ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç!</strong></div>
        <div class="spinner spinner-lg" style="margin:0 auto 28px"></div>
        <div class="step-list">
          <div class="step-item" id="s1">‚è≥ AI ‡§∏‡•á connect ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</div>
          <div class="step-item" id="s2">‚è≥ 5 Easy (‡§Ü‡§∏‡§æ‡§®) ‡§∏‡§µ‡§æ‡§≤ ‡§¨‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</div>
          <div class="step-item" id="s3">‚è≥ 5 Medium (‡§Æ‡§ß‡•ç‡§Ø‡§Æ) ‡§∏‡§µ‡§æ‡§≤ ‡§¨‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</div>
          <div class="step-item" id="s4">‚è≥ 5 Hard (‡§ï‡§†‡§ø‡§®) ‡§∏‡§µ‡§æ‡§≤ ‡§¨‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</div>
          <div class="step-item" id="s5">‚è≥ Quiz ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</div>
        </div>
        <div id="retrySection" style="display:none;margin-top:20px">
          <div style="color:var(--muted);font-size:14px;margin-bottom:12px" id="retryMsg">Error ‡§Ü‡§Ø‡§æ</div>
          <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <button class="btn btn-green" onclick="retryQuiz()">üîÑ ‡§´‡§ø‡§∞ Try ‡§ï‡§∞‡•ã</button>
            <button class="btn btn-outline" onclick="showPage('topicPage')">‚Üê Topic ‡§¨‡§¶‡§≤‡•ã</button>
          </div>
          <p style="font-size:12px;color:var(--muted);margin-top:12px">üí° Retry ‡§™‡§∞ click ‡§ï‡§∞‡•ã ‚Äî backend ‡§Ö‡§¨ warm ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à, fast load ‡§π‡•ã‡§ó‡§æ!</p>
        </div>
      </div>
    </div>

    <!-- GAME PAGE -->
    <div id="gamePage" style="display:none">
      <div class="quiz-header">
        <div>
          <div class="level-badge level-easy" id="levelBadge">‡§Ü‡§∏‡§æ‡§®</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px" id="topicLabel">Topic</div>
        </div>
        <div class="quiz-progress">
          <div class="progress-track"><div class="progress-bar-fill" id="progressBar"></div></div>
          <div class="q-meta">‡§™‡•ç‡§∞‡§∂‡•ç‡§® <span id="qNum">1</span> / 15</div>
        </div>
        <div>
          <div class="timer-box" id="timerBox">30</div>
          <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:3px">seconds</div>
        </div>
      </div>
      <div class="question-card">
        <div class="question-text" id="qText">Question</div>
        <div class="options-grid" id="optionsGrid"></div>
        <div class="explain-box" id="explainBox"></div>
      </div>
      <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" style="display:none;margin-top:4px">‡§Ö‡§ó‡§≤‡§æ ‡§∏‡§µ‡§æ‡§≤ ‚Üí</button>
    </div>

    <!-- RESULT PAGE -->
    <div id="resultPage" style="display:none">
      <div class="result-wrap">
        <h2 style="font-size:28px;margin-bottom:20px">üèÅ Quiz ‡§ñ‡§§‡•ç‡§Æ!</h2>
        <div class="score-circle">
          <div class="score-big" id="scoreBig">0</div>
          <div class="score-of">/ 15</div>
        </div>
        <div class="grade" id="gradeText"></div>
        <p id="gradeMsg" style="color:var(--muted);font-size:14px;margin-bottom:16px"></p>
        <div class="stat-row">
          <div class="stat-item"><div class="val" id="statCorrect" style="color:var(--green)">0</div><div class="lbl">‚úÖ ‡§∏‡§π‡•Ä</div></div>
          <div class="stat-item"><div class="val" id="statWrong"   style="color:var(--primary)">0</div><div class="lbl">‚ùå ‡§ó‡§≤‡§§</div></div>
          <div class="stat-item"><div class="val" id="statTime"    style="color:var(--blue)">0s</div><div class="lbl">‚è± Time</div></div>
          <div class="stat-item"><div class="val" id="statPct"     style="color:var(--gold)">0%</div><div class="lbl">üìä Score</div></div>
        </div>

        <!-- TeamCoin Claim Box -->
        <div class="coin-claim-box" id="coinBox">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
            <div class="coin-amount" id="coinAmount">ü™ô 0</div>
            <div>
              <div style="font-weight:700">TeamCoins ‡§Æ‡§ø‡§≤‡•á‡§Ç‡§ó‡•á!</div>
              <div style="font-size:12px;color:var(--muted)">Score √ó 2 <span id="bonusNote"></span></div>
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">TeamCoin Username (apna wala)</label>
            <input class="input" id="tcUsername" placeholder="TeamCoin username..." />
          </div>
          <div id="coinAlert" class="alert"></div>
          <button class="btn btn-gold btn-full" onclick="claimCoins()" id="claimBtn">ü™ô TeamCoins Claim ‡§ï‡§∞‡•ã!</button>
          <p style="font-size:11px;color:var(--muted);margin-top:8px">TeamCoin account ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à? <a href="https://rajuagi.github.io/teamcoin-frontend/register.html" target="_blank" style="color:var(--gold)">‡§Ø‡§π‡§æ‡§Å ‡§¨‡§®‡§æ‡§ì</a></p>
        </div>

        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="retryQuiz()">üîÑ Same Topic</button>
          <button class="btn btn-outline" onclick="showPage('topicPage')">üìö ‡§®‡§Ø‡§æ Topic</button>
          <a href="leaderboard.html" class="btn btn-outline">üèÜ Leaderboard</a>
        </div>
      </div>
    </div>

  </main>
  <div id="footer-placeholder"></div>
  <script src="nav.js"></script>
  <script>
    const TOPICS = [
      {name:"‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ú‡•ç‡§û‡§æ‡§®",icon:"üåü"},{name:"‡§≠‡§æ‡§∞‡§§ ‡§ï‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏",icon:"üèõÔ∏è"},
      {name:"‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®",icon:"üî¨"},{name:"‡§≠‡•Ç‡§ó‡•ã‡§≤",icon:"üåç"},
      {name:"‡§ó‡§£‡§ø‡§§",icon:"‚ûó"},{name:"English Grammar",icon:"üî§"},
      {name:"Computer Science",icon:"üíª"},{name:"Indian Constitution",icon:"üìú"},
      {name:"Current Affairs",icon:"üì∞"},{name:"Sports",icon:"üèè"},
      {name:"Economics",icon:"üìà"},{name:"Chemistry",icon:"‚öóÔ∏è"},
    ];

    let questions  = [], qIndex = 0, score = 0, wrongCount = 0;
    let timer = null, timeLeft = 30, totalTime = 0;
    let currentTopic = "";
    let answered     = false;

    function showPage(id) {
      ["topicPage","loadingPage","gamePage","resultPage"].forEach(p => {
        document.getElementById(p).style.display = p===id ? "block" : "none";
      });
    }

    // ===== RENDER TOPICS =====
    function renderTopics() {
      const grid = document.getElementById("topicGrid");
      TOPICS.forEach(t => {
        const d = document.createElement("div");
        d.className = "topic-btn";
        d.innerHTML = `<div class="t-icon">${t.icon}</div><h4>${t.name}</h4>`;
        d.onclick   = () => startQuiz(t.name);
        grid.appendChild(d);
      });
    }

    function startQuizCustom() {
      const val = document.getElementById("customTopicInput").value.trim();
      if (!val) { document.getElementById("customTopicInput").focus(); return; }
      startQuiz(val);
    }

    // ===== START QUIZ =====
    async function startQuiz(topic) {
      currentTopic = topic;
      questions    = []; qIndex = 0; score = 0; wrongCount = 0; totalTime = 0;
      showPage("loadingPage");
      document.getElementById("loadingTitle").innerText = `"${topic}" ‡§ï‡•á 15 bilingual ‡§∏‡§µ‡§æ‡§≤ ‡§¨‡§® ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...`;
      document.getElementById("retrySection").style.display = "none";
      document.querySelector(".spinner.spinner-lg").style.display = "block";

      // Step animation
      ["s1","s2","s3","s4","s5"].forEach((id,i) => {
        const el = document.getElementById(id);
        el.className = "step-item";
        el.innerHTML = `‚è≥ ${el.innerText.replace("‚úÖ ","").replace("‚è≥ ","")}`;
      });
      let stepN = 0;
      const stepTimer = setInterval(() => {
        if (stepN > 0) {
          const prev = document.getElementById("s"+stepN);
          prev.className = "step-item done";
          prev.innerHTML = "‚úÖ " + prev.innerText.replace("‚è≥ ","").replace("‚úÖ ","");
        }
        stepN++;
        if (stepN <= 5) {
          const cur = document.getElementById("s"+stepN);
          cur.className = "step-item active";
        }
      }, 4000);

      // 120 second timeout
      const ctrl = new AbortController();
      const tId  = setTimeout(() => ctrl.abort(), 120000);

      // Pre-wake backend
      fetch(`${BACKEND}/`).catch(()=>{});

      try {
        const res  = await fetch(`${BACKEND}/quiz`, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({topic}),
          signal: ctrl.signal
        });
        clearTimeout(tId); clearInterval(stepTimer);
        const data = await res.json();

        if (data.error || !data.questions?.length) throw new Error(data.error||"Quiz generate ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à");

        questions = data.questions;
        ["s1","s2","s3","s4","s5"].forEach(id => {
          const el = document.getElementById(id);
          el.className = "step-item done";
          el.innerHTML = "‚úÖ " + el.innerText.replace(/[‚è≥‚úÖ] /,"");
        });
        setTimeout(() => { showPage("gamePage"); renderQuestion(); }, 500);

      } catch (err) {
        clearTimeout(tId); clearInterval(stepTimer);
        document.querySelector(".spinner.spinner-lg").style.display = "none";
        document.getElementById("retrySection").style.display = "block";
        document.getElementById("retryMsg").innerText = err.name==="AbortError"
          ? "‚è± 120 seconds ‡§¨‡§æ‡§¶ ‡§≠‡•Ä ‡§ú‡§µ‡§æ‡§¨ ‡§®‡§π‡•Ä‡§Ç ‡§Ü‡§Ø‡§æ‡•§ Backend warm ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à ‚Äî ‡§Ö‡§¨ retry ‡§ï‡§∞‡•ã!"
          : `‚ùå ${err.message||"Backend ‡§∏‡•á connect ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§Ø‡§æ‡•§"}`;
      }
    }

    function retryQuiz() { if (currentTopic) startQuiz(currentTopic); }

    // ===== RENDER QUESTION =====
    function renderQuestion() {
      if (qIndex >= questions.length) { showResult(); return; }
      answered = false;
      const q  = questions[qIndex];
      const pct = (qIndex / questions.length * 100);

      document.getElementById("progressBar").style.width = pct + "%";
      document.getElementById("qNum").innerText          = qIndex + 1;
      document.getElementById("topicLabel").innerText    = currentTopic;

      // Level badge
      const lb  = document.getElementById("levelBadge");
      const lvl = (q.level||"").toLowerCase();
      lb.className = "level-badge " + (lvl.includes("easy")||lvl.includes("‡§Ü‡§∏‡§æ‡§®") ? "level-easy" : lvl.includes("hard")||lvl.includes("‡§ï‡§†‡§ø‡§®") ? "level-hard" : "level-medium");
      lb.innerText = q.level || "‡§Æ‡§ß‡•ç‡§Ø‡§Æ";

      document.getElementById("qText").innerHTML = q.q;
      document.getElementById("explainBox").style.display = "none";
      document.getElementById("nextBtn").style.display    = "none";

      // Options
      const grid = document.getElementById("optionsGrid");
      grid.innerHTML = "";
      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.innerHTML = `<strong style="color:var(--primary)">${["A","B","C","D"][i]})</strong> ${opt}`;
        btn.onclick   = () => selectAnswer(i, btn);
        grid.appendChild(btn);
      });

      // Timer
      clearInterval(timer);
      timeLeft = q.level?.includes("‡§ï‡§†‡§ø‡§®")||q.level?.includes("Hard") ? 45 : 30;
      const tb = document.getElementById("timerBox");
      tb.innerText    = timeLeft;
      tb.className    = "timer-box";
      timer = setInterval(() => {
        timeLeft--; totalTime++;
        tb.innerText = timeLeft;
        tb.className = "timer-box" + (timeLeft <= 10 ? " warn" : "");
        if (timeLeft <= 0) {
          clearInterval(timer);
          timeUp();
        }
      }, 1000);
    }

    function selectAnswer(idx, btn) {
      if (answered) return;
      answered = true;
      clearInterval(timer);
      totalTime += (questions[qIndex].level?.includes("‡§ï‡§†‡§ø‡§®")||questions[qIndex].level?.includes("Hard") ? 45 : 30) - timeLeft;

      const q       = questions[qIndex];
      const correct = q.ans;
      const allBtns = document.querySelectorAll(".option-btn");

      allBtns.forEach((b, i) => {
        b.disabled  = true;
        if (i === correct) b.classList.add("correct");
        else if (i === idx && idx !== correct) b.classList.add("wrong");
      });

      if (idx === correct) score++;
      else wrongCount++;

      // Explanation
      if (q.explanation) {
        const ex = document.getElementById("explainBox");
        ex.innerHTML = `üí° <strong>Explanation:</strong> ${q.explanation}`;
        ex.style.display = "block";
      }

      qIndex++;
      document.getElementById("nextBtn").style.display = "block";
    }

    function timeUp() {
      answered = true;
      const q   = questions[qIndex];
      document.querySelectorAll(".option-btn").forEach((b,i) => {
        b.disabled = true;
        if (i === q.ans) b.classList.add("correct");
      });
      wrongCount++;
      if (q.explanation) {
        const ex = document.getElementById("explainBox");
        ex.innerHTML = `‚è± Time Up! üí° <strong>‡§∏‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨:</strong> ${q.options[q.ans]}<br>${q.explanation}`;
        ex.style.display = "block";
      }
      qIndex++;
      document.getElementById("nextBtn").style.display = "block";
    }

    function nextQuestion() { renderQuestion(); }

    // ===== RESULT =====
    function showResult() {
      clearInterval(timer);
      showPage("resultPage");
      const total = questions.length;
      const pct   = Math.round(score / total * 100);
      document.getElementById("scoreBig").innerText    = score;
      document.getElementById("statCorrect").innerText = score;
      document.getElementById("statWrong").innerText   = wrongCount;
      document.getElementById("statTime").innerText    = totalTime + "s";
      document.getElementById("statPct").innerText     = pct + "%";

      // Grade
      const { grade, msg, cls } = pct>=90 ? {grade:"A+ üèÖ",msg:"‡§∂‡§æ‡§®‡§¶‡§æ‡§∞! ‡§Ü‡§™ ‡§è‡§ï ‡§™‡•ç‡§∞‡§§‡§ø‡§≠‡§æ‡§∂‡§æ‡§≤‡•Ä ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§π‡•à‡§Ç!",cls:"grade-A"}
        : pct>=75 ? {grade:"A ü•á",msg:"‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! ‡§Æ‡•á‡§π‡§®‡§§ ‡§∞‡§Ç‡§ó ‡§≤‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à!",cls:"grade-A"}
        : pct>=60 ? {grade:"B ü•à",msg:"‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§ï‡§ø‡§Ø‡§æ! ‡§•‡•ã‡§°‡§º‡•Ä ‡§î‡§∞ practice ‡§ï‡§∞‡•ã‡•§",cls:"grade-B"}
        : pct>=40 ? {grade:"C ü•â",msg:"‡§†‡•Ä‡§ï ‡§π‡•à‡•§ Regular ‡§™‡§¢‡§º‡§æ‡§à ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•ã‡•§",cls:"grade-C"}
        : {grade:"D üìö",msg:"‡§Æ‡•á‡§π‡§®‡§§ ‡§ï‡§∞‡§§‡•á ‡§∞‡§π‡•ã ‚Äî next time ‡§ú‡§∞‡•Ç‡§∞ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§π‡•ã‡§ó‡§æ!",cls:"grade-D"};
      document.getElementById("gradeText").innerText = grade;
      document.getElementById("gradeText").className  = `grade ${cls}`;
      document.getElementById("gradeMsg").innerText   = msg;

      // Coins
      const coins  = score * 2 + (pct >= 80 ? 10 : 0);
      document.getElementById("coinAmount").innerText = `ü™ô ${coins} Coins`;
      document.getElementById("bonusNote").innerText  = pct >= 80 ? "+ 10 Bonus (80% ‡§∏‡•á ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ!)" : "";

      // Pre-fill TC username
      const tcUser = localStorage.getItem("tc_username")||"";
      if (tcUser) document.getElementById("tcUsername").value = tcUser;

      // Save score to leaderboard
      const name = getUserName() || localStorage.getItem("at_name") || "Guest";
      api("/save-score","POST",{name, score, total, topic:currentTopic}).catch(()=>{});
    }

    // ===== CLAIM COINS =====
    async function claimCoins() {
      const username = document.getElementById("tcUsername").value.trim();
      if (!username) { showAlert("coinAlert","TeamCoin username ‡§°‡§æ‡§≤‡•ã!","error"); return; }
      localStorage.setItem("tc_username", username);

      const score_ = parseInt(document.getElementById("scoreBig").innerText);
      const total  = questions.length;
      const pct    = score_ / total * 100;
      const coins  = score_ * 2 + (pct >= 80 ? 10 : 0);

      document.getElementById("claimBtn").disabled = true;
      document.getElementById("claimBtn").innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px"></div> Claim ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';

      try {
        const data = await api("/claim-quiz-coins","POST",{username, score:score_, total, topic:currentTopic, coins});
        if (data.error) { showAlert("coinAlert", data.error, "error"); }
        else { showAlert("coinAlert", `üéâ ${coins} TeamCoins ‡§Æ‡§ø‡§≤ ‡§ó‡§è! TeamCoin dashboard check ‡§ï‡§∞‡•ã‡•§`, "success", 0); document.getElementById("claimBtn").style.display="none"; }
      } catch { showAlert("coinAlert","Network error‡•§ ‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞ ‡§¨‡§æ‡§¶ try ‡§ï‡§∞‡•ã‡•§","error"); }
      finally { document.getElementById("claimBtn").disabled = false; document.getElementById("claimBtn").innerHTML = "ü™ô TeamCoins Claim ‡§ï‡§∞‡•ã!"; }
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderTopics();
      document.getElementById("customTopicInput").addEventListener("keypress", e => { if(e.key==="Enter") startQuizCustom(); });
    });
  </script>
</body>
</html>
