<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courses ‚Äî AI Teacher</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .courses-layout { display:grid; grid-template-columns:280px 1fr; gap:24px; }
    .sidebar { background:var(--dark2); border:1px solid var(--border); border-radius:14px; padding:16px; height:fit-content; position:sticky; top:82px; }
    .sidebar h3 { font-size:14px; font-weight:700; color:var(--muted); margin-bottom:12px; text-transform:uppercase; letter-spacing:1px; }
    .course-btn { display:flex; align-items:center; gap:10px; width:100%; padding:10px 12px; border-radius:10px; border:none; background:transparent; color:var(--text); cursor:pointer; font-size:14px; font-weight:600; font-family:'Hind',sans-serif; text-align:left; transition:all 0.2s; margin-bottom:4px; }
    .course-btn:hover  { background:var(--dark3); }
    .course-btn.active { background:var(--primary); color:white; }
    .add-course-btn { border:1px dashed var(--border); color:var(--muted); justify-content:center; font-weight:500; }
    .add-course-btn:hover { border-color:var(--primary); color:var(--primary); background:rgba(233,69,96,0.08); }
    .divider-line { border:none; border-top:1px solid var(--border); margin:12px 0; }
    .topics-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr)); gap:14px; margin-bottom:24px; }
    .topic-card { background:var(--dark3); border:1px solid var(--border); border-radius:12px; padding:16px; cursor:pointer; transition:all 0.2s; }
    .topic-card:hover { border-color:var(--primary); transform:translateY(-2px); }
    .topic-card .icon { font-size:30px; margin-bottom:8px; }
    .topic-card h4 { font-size:14px; font-weight:700; color:var(--text); margin-bottom:4px; }
    .topic-card p  { font-size:12px; color:var(--muted); }
    .topic-card.user-added { border-color:var(--gold); background:rgba(244,196,48,0.05); }
    .explain-panel { background:var(--dark2); border:1px solid var(--border); border-radius:14px; padding:24px; display:none; }
    .explain-panel h2 { font-size:22px; margin-bottom:6px; }
    .explain-panel .meta { font-size:13px; color:var(--muted); margin-bottom:16px; display:flex; gap:16px; flex-wrap:wrap; }
    .explain-content { font-size:15px; line-height:1.9; color:var(--text); white-space:pre-wrap; }
    .explain-content h1,h2,h3 { color:var(--primary); }
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:200; align-items:center; justify-content:center; }
    .modal-overlay.active { display:flex; }
    .modal-box { background:var(--dark2); border:1px solid var(--border); border-radius:16px; padding:28px; width:90%; max-width:440px; }
    .modal-box h3 { margin-bottom:20px; font-size:18px; }
    .audio-bar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:16px; background:var(--dark3); border-radius:10px; padding:12px; }
    .progress-bar { flex:1; height:6px; background:var(--border); border-radius:3px; overflow:hidden; min-width:80px; }
    .progress-fill { height:100%; background:var(--primary); width:0%; transition:width 0.3s; }
    @media(max-width:768px){ .courses-layout{grid-template-columns:1fr} .sidebar{position:static} }
  </style>
</head>
<body>
  <div id="nav-placeholder"></div>
  <main class="page-wrap">
    <div class="page-header">
      <h1>üìö Courses</h1>
      <p>Topic ‡§ö‡•Å‡§®‡•ã ‚Üí 1000+ ‡§∂‡§¨‡•ç‡§¶‡•ã‡§Ç ‡§Æ‡•á‡§Ç explanation ‚Üí ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§®‡•ã</p>
    </div>

    <div class="courses-layout">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <h3>üìÇ Subjects</h3>
        <div id="courseList"></div>
        <hr class="divider-line">
        <button class="course-btn add-course-btn" onclick="openAddCourse()">Ôºã ‡§®‡§Ø‡§æ Subject</button>
        <hr class="divider-line">
        <h3>‚≠ê My Topics</h3>
        <div id="myTopicList" style="font-size:13px;color:var(--muted)">Login ‡§ï‡§∞‡•ã dekhne ke liye</div>
      </div>

      <!-- MAIN AREA -->
      <div>
        <!-- Topics grid -->
        <div id="topicsArea">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 id="courseTitle" style="font-size:20px">Subject ‡§ö‡•Å‡§®‡•ã</h2>
            <button class="btn btn-outline btn-sm" onclick="openAddTopic()">Ôºã ‡§®‡§Ø‡§æ Topic</button>
          </div>
          <div class="topics-grid" id="topicsGrid">
            <div style="color:var(--muted);font-size:14px;grid-column:1/-1">‚Üê Left ‡§∏‡•á Subject ‡§ö‡•Å‡§®‡•ã</div>
          </div>
        </div>

        <!-- Explain panel -->
        <div class="explain-panel" id="explainPanel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <h2 id="explainTitle">Topic</h2>
            <button class="btn btn-outline btn-sm" onclick="closeExplain()">‚úï ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•ã</button>
          </div>
          <div class="meta">
            <span id="explainCourse">üìö</span>
            <span id="explainWordCount">üìù 1000+ words</span>
          </div>

          <!-- Audio controls -->
          <div class="audio-bar" id="audioBar" style="display:none">
            <button class="btn btn-sm btn-primary" onclick="toggleExplainAudio()">‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•ã</button>
            <div class="progress-bar"><div class="progress-fill" id="audioProg"></div></div>
            <span id="audioStatus" style="font-size:12px;color:var(--muted)">Ready</span>
            <button class="btn btn-sm btn-outline" onclick="stopExplainAudio()">‚èπ</button>
            <button class="btn btn-sm btn-outline" onclick="speakBrowserExplain()">üó£Ô∏è</button>
          </div>

          <div id="explainLoading" style="display:flex;align-items:center;gap:12px;padding:20px;color:var(--muted)">
            <div class="spinner spinner-lg"></div>
            <div>
              <div style="font-weight:700;margin-bottom:4px">AI Explanation ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</div>
              <div style="font-size:13px">1000+ ‡§∂‡§¨‡•ç‡§¶‡•ã‡§Ç ‡§Æ‡•á‡§Ç detailed explanation ‡§Ü ‡§∞‡§π‡•Ä ‡§π‡•à‡•§ 15-20 seconds ‡§≤‡§ó‡•á‡§Ç‡§ó‡•á‡•§</div>
            </div>
          </div>
          <div class="explain-content" id="explainContent" style="display:none"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Course Modal -->
  <div class="modal-overlay" id="addCourseModal">
    <div class="modal-box">
      <h3>üìÇ ‡§®‡§Ø‡§æ Subject ‡§ú‡•ã‡§°‡§º‡•ã</h3>
      <div class="input-group">
        <label class="input-label">Subject ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
        <input class="input" id="newCourseName" placeholder="‡§ú‡•à‡§∏‡•á: ‡§á‡§§‡§ø‡§π‡§æ‡§∏, Chemistry, English..." />
      </div>
      <div class="input-group">
        <label class="input-label">Icon (Emoji)</label>
        <input class="input" id="newCourseIcon" placeholder="üìö" maxlength="4" value="üìö" />
      </div>
      <div id="addCourseAlert" class="alert"></div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <button class="btn btn-primary" onclick="saveNewCourse()">‡§ú‡•ã‡§°‡§º‡•ã</button>
        <button class="btn btn-outline" onclick="document.getElementById('addCourseModal').classList.remove('active')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add Topic Modal -->
  <div class="modal-overlay" id="addTopicModal">
    <div class="modal-box">
      <h3>üìù ‡§®‡§Ø‡§æ Topic ‡§ú‡•ã‡§°‡§º‡•ã</h3>
      <div class="input-group">
        <label class="input-label">Topic ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
        <input class="input" id="newTopicName" placeholder="‡§ú‡•à‡§∏‡•á: ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂ ‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£, Newton Laws..." />
      </div>
      <div id="addTopicAlert" class="alert"></div>
      <div style="display:flex;gap:10px;margin-top:8px">
        <button class="btn btn-primary" onclick="saveNewTopic()">‡§ú‡•ã‡§°‡§º‡•ã</button>
        <button class="btn btn-outline" onclick="document.getElementById('addTopicModal').classList.remove('active')">Cancel</button>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>
  <script src="nav.js"></script>
  <script>
    // ===== BUILT-IN COURSES =====
    const BUILT_IN = [
      { id:"science", name:"‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®", icon:"üî¨", topics:[
        {name:"‡§™‡•ç‡§∞‡§ï‡§æ‡§∂ ‡§∏‡§Ç‡§∂‡•ç‡§≤‡•á‡§∑‡§£",icon:"üåø"},{name:"Newton ‡§ï‡•á ‡§®‡§ø‡§Ø‡§Æ",icon:"‚öôÔ∏è"},
        {name:"DNA ‡§î‡§∞ RNA",icon:"üß¨"},{name:"Solar System",icon:"‚òÄÔ∏è"},
        {name:"Chemical Reactions",icon:"‚öóÔ∏è"},{name:"Human Body",icon:"ü´Ä"}]},
      { id:"history", name:"‡§á‡§§‡§ø‡§π‡§æ‡§∏", icon:"üèõÔ∏è", topics:[
        {name:"‡§Æ‡•å‡§∞‡•ç‡§Ø ‡§∏‡§æ‡§Æ‡•ç‡§∞‡§æ‡§ú‡•ç‡§Ø",icon:"üëë"},{name:"‡§Æ‡•Å‡§ó‡§≤ ‡§∏‡§æ‡§Æ‡•ç‡§∞‡§æ‡§ú‡•ç‡§Ø",icon:"üïå"},
        {name:"Independence Movement",icon:"üáÆüá≥"},{name:"World War II",icon:"üåç"},
        {name:"Indus Valley Civilization",icon:"üè∫"},{name:"Gupta Empire",icon:"üìú"}]},
      { id:"maths", name:"‡§ó‡§£‡§ø‡§§", icon:"‚ûó", topics:[
        {name:"Quadratic Equations",icon:"üìê"},{name:"Trigonometry",icon:"üìè"},
        {name:"Probability",icon:"üé≤"},{name:"Statistics",icon:"üìä"},
        {name:"Calculus Basics",icon:"‚à´"},{name:"Geometry",icon:"üìê"}]},
      { id:"geography", name:"‡§≠‡•Ç‡§ó‡•ã‡§≤", icon:"üåç", topics:[
        {name:"‡§≠‡§æ‡§∞‡§§ ‡§ï‡•Ä ‡§®‡§¶‡§ø‡§Ø‡§æ‡§Å",icon:"üåä"},{name:"Climate Change",icon:"üå°Ô∏è"},
        {name:"Tectonic Plates",icon:"‚õ∞Ô∏è"},{name:"Indian States",icon:"üó∫Ô∏è"},
        {name:"Monsoon System",icon:"üåßÔ∏è"},{name:"Natural Resources",icon:"üíé"}]},
      { id:"civics", name:"‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞", icon:"‚öñÔ∏è", topics:[
        {name:"Indian Constitution",icon:"üìú"},{name:"Parliament",icon:"üèõÔ∏è"},
        {name:"Fundamental Rights",icon:"ü§ù"},{name:"Supreme Court",icon:"‚öñÔ∏è"},
        {name:"Panchayati Raj",icon:"üèòÔ∏è"},{name:"Elections in India",icon:"üó≥Ô∏è"}]},
      { id:"english", name:"English", icon:"üî§", topics:[
        {name:"Grammar Basics",icon:"üìù"},{name:"Essay Writing",icon:"‚úçÔ∏è"},
        {name:"Comprehension",icon:"üìñ"},{name:"Vocabulary",icon:"üìö"},
        {name:"Letter Writing",icon:"‚úâÔ∏è"},{name:"Tenses",icon:"‚è∞"}]},
    ];

    let activeCourseId = null;
    let currentTopic   = null;
    let currentCourse  = null;
    let explainAudio   = null;
    let explainAudioCtx= null;
    let fullExplainText= "";

    // ===== USER COURSES (localStorage) =====
    function getUserCourses() {
      try { return JSON.parse(localStorage.getItem("at_courses")||"[]"); } catch { return []; }
    }
    function saveUserCourses(c) { localStorage.setItem("at_courses", JSON.stringify(c)); }

    function getUserTopics(courseId) {
      try { return JSON.parse(localStorage.getItem(`at_topics_${courseId}`)||"[]"); } catch { return []; }
    }
    function saveUserTopics(courseId, topics) { localStorage.setItem(`at_topics_${courseId}`, JSON.stringify(topics)); }

    // ===== RENDER SIDEBAR =====
    function renderSidebar() {
      const list = document.getElementById("courseList");
      list.innerHTML = "";
      const userCourses = getUserCourses();
      const allCourses  = [...BUILT_IN, ...userCourses];

      allCourses.forEach(c => {
        const btn = document.createElement("button");
        btn.className = `course-btn${activeCourseId===c.id?" active":""}`;
        btn.innerHTML = `${c.icon} ${c.name}`;
        btn.onclick   = () => selectCourse(c);
        list.appendChild(btn);
      });

      // My topics (user-added to any course)
      const myBox = document.getElementById("myTopicList");
      if (isLoggedIn()) {
        const allUserTopics = allCourses.flatMap(c => 
          getUserTopics(c.id).map(t => ({...t, courseName:c.name, courseId:c.id}))
        );
        if (!allUserTopics.length) {
          myBox.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:6px">‡§ï‡•ã‡§à topic ‡§®‡§π‡•Ä‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§Ö‡§≠‡•Ä ‡§§‡§ï</div>`;
        } else {
          myBox.innerHTML = allUserTopics.map(t => 
            `<button class="course-btn" style="font-size:12px" onclick="selectTopicDirect('${t.name}','${t.courseName}')">‚≠ê ${t.name}</button>`
          ).join("");
        }
      }
    }

    function selectCourse(course) {
      activeCourseId = course.id;
      currentCourse  = course;
      closeExplain();
      document.getElementById("courseTitle").innerText = `${course.icon} ${course.name}`;

      const userTopics  = getUserTopics(course.id).map(t => ({...t, isUser:true}));
      const builtTopics = (course.topics||[]);
      const all         = [...builtTopics, ...userTopics];

      const grid = document.getElementById("topicsGrid");
      grid.innerHTML = "";
      all.forEach(t => {
        const d = document.createElement("div");
        d.className = `topic-card${t.isUser?" user-added":""}`;
        d.innerHTML = `<div class="icon">${t.icon||"üìù"}</div><h4>${t.name}</h4><p>${t.isUser?"‚≠ê ‡§Ü‡§™‡§ï‡§æ topic":"Tap ‡§ï‡§∞‡•ã ‚Üí explain ‡§π‡•ã‡§ó‡§æ"}</p>`;
        d.onclick   = () => explainTopic(t.name, course.name);
        grid.appendChild(d);
      });
      renderSidebar();
    }

    function selectTopicDirect(topicName, courseName) {
      explainTopic(topicName, courseName);
    }

    // ===== EXPLAIN =====
    async function explainTopic(topicName, courseName) {
      currentTopic  = topicName;
      document.getElementById("topicsArea").style.display    = "none";
      document.getElementById("explainPanel").style.display  = "block";
      document.getElementById("explainTitle").innerText       = topicName;
      document.getElementById("explainCourse").innerText      = `üìö ${courseName}`;
      document.getElementById("explainLoading").style.display = "flex";
      document.getElementById("explainContent").style.display = "none";
      document.getElementById("audioBar").style.display      = "none";
      stopExplainAudio();
      fullExplainText = "";

      try {
        const data = await api("/explain","POST",{topic:topicName, course:courseName});
        if (data.error) throw new Error(data.error);
        fullExplainText = data.text || "";
        const words = fullExplainText.split(/\s+/).length;
        document.getElementById("explainWordCount").innerText = `üìù ${words} words`;
        document.getElementById("explainContent").innerText  = fullExplainText;
        document.getElementById("explainLoading").style.display = "none";
        document.getElementById("explainContent").style.display = "block";
        document.getElementById("audioBar").style.display       = "flex";

        if (data.audio) {
          playExplainAudio(data.audio);
        }
      } catch (e) {
        document.getElementById("explainLoading").innerHTML = `
          <div>
            <div style="color:var(--primary);font-weight:700">‚ùå ${e.message||"Error ‡§Ü‡§Ø‡§æ"}</div>
            <button class="btn btn-sm btn-primary" onclick="explainTopic('${topicName}','${courseName}')" style="margin-top:10px">üîÑ ‡§´‡§ø‡§∞ Try ‡§ï‡§∞‡•ã</button>
          </div>`;
      }
    }

    function closeExplain() {
      document.getElementById("topicsArea").style.display   = "block";
      document.getElementById("explainPanel").style.display = "none";
      stopExplainAudio();
    }

    // ===== AUDIO =====
    function playExplainAudio(b64) {
      stopExplainAudio();
      explainAudio = new Audio("data:audio/mp3;base64," + b64);
      explainAudio.playbackRate = 1.15;
      explainAudio.ontimeupdate = () => {
        const pct = (explainAudio.currentTime / explainAudio.duration * 100) || 0;
        document.getElementById("audioProg").style.width = pct + "%";
        document.getElementById("audioStatus").innerText = formatTime(explainAudio.currentTime) + " / " + formatTime(explainAudio.duration);
      };
      explainAudio.play().catch(()=>{});
      document.querySelector("#audioBar button").innerHTML = "‚è∏ ‡§∞‡•Å‡§ï‡•ã";
    }

    function toggleExplainAudio() {
      if (!explainAudio) return;
      if (explainAudio.paused) { explainAudio.play(); document.querySelector("#audioBar button").innerHTML = "‚è∏ ‡§∞‡•Å‡§ï‡•ã"; }
      else { explainAudio.pause(); document.querySelector("#audioBar button").innerHTML = "‚ñ∂Ô∏è ‡§∏‡•Å‡§®‡•ã"; }
    }

    function stopExplainAudio() {
      if (explainAudio) { explainAudio.pause(); explainAudio = null; }
      document.getElementById("audioProg").style.width = "0%";
    }

    function speakBrowserExplain() {
      if (!fullExplainText) return;
      window.speechSynthesis.cancel();
      const chunks = fullExplainText.match(/.{1,200}/gs)||[];
      let i = 0;
      function speakNext() {
        if (i >= chunks.length) return;
        const u = new SpeechSynthesisUtterance(chunks[i++]);
        const voices = window.speechSynthesis.getVoices();
        const hi = voices.find(v=>v.lang==="hi-IN")||voices.find(v=>v.lang.startsWith("hi"));
        if (hi) u.voice = hi;
        u.lang = "hi-IN"; u.rate = 0.85;
        u.onend = speakNext;
        window.speechSynthesis.speak(u);
      }
      speakNext();
    }

    function formatTime(s) {
      if (!s || isNaN(s)) return "0:00";
      return Math.floor(s/60)+":"+String(Math.floor(s%60)).padStart(2,"0");
    }

    // ===== ADD COURSE =====
    function openAddCourse() {
      if (!isLoggedIn()) { window.location.href="login.html"; return; }
      document.getElementById("addCourseModal").classList.add("active");
    }

    function saveNewCourse() {
      const name = document.getElementById("newCourseName").value.trim();
      const icon = document.getElementById("newCourseIcon").value.trim()||"üìö";
      if (!name) { showAlert("addCourseAlert","‡§®‡§æ‡§Æ ‡§°‡§æ‡§≤‡•ã","error"); return; }
      const courses = getUserCourses();
      const id = "user_"+Date.now();
      courses.push({id, name, icon, topics:[]});
      saveUserCourses(courses);
      document.getElementById("addCourseModal").classList.remove("active");
      document.getElementById("newCourseName").value="";
      renderSidebar();
    }

    // ===== ADD TOPIC =====
    function openAddTopic() {
      if (!isLoggedIn()) { window.location.href="login.html"; return; }
      if (!activeCourseId) { alert("‡§™‡§π‡§≤‡•á Subject ‡§ö‡•Å‡§®‡•ã"); return; }
      document.getElementById("addTopicModal").classList.add("active");
    }

    function saveNewTopic() {
      const name = document.getElementById("newTopicName").value.trim();
      if (!name) { showAlert("addTopicAlert","Topic ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§°‡§æ‡§≤‡•ã","error"); return; }
      const topics = getUserTopics(activeCourseId);
      topics.push({name, icon:"‚≠ê"});
      saveUserTopics(activeCourseId, topics);
      document.getElementById("addTopicModal").classList.remove("active");
      document.getElementById("newTopicName").value="";
      if (currentCourse) selectCourse(currentCourse);
    }

    // Close modals on overlay click
    document.querySelectorAll(".modal-overlay").forEach(m => {
      m.addEventListener("click", e => { if(e.target===m) m.classList.remove("active"); });
    });

    // Init
    document.addEventListener("DOMContentLoaded", renderSidebar);
  </script>
</body>
</html>
